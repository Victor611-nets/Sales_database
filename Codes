CREATE TABLE sales_staging (
    sales_person   TEXT,
    country         TEXT,
    product         TEXT,
    sale_date       TEXT,
    amount          TEXT,
    boxes_shipped   TEXT
);

CREATE TABLE sales (
    sales_person   VARCHAR(100),
    country         VARCHAR(50),
    product         VARCHAR(100),
    sale_date       DATE,
    amount          NUMERIC(12,2),
    boxes_shipped   INT
);


INSERT INTO sales (
    sales_person,
    country,
    product,
    sale_date,
    amount,
    boxes_shipped
)
SELECT
    sales_person,
    country,
    product,
    TO_DATE(sale_date, 'DD/MM/YYYY'),
    REPLACE(REPLACE(amount, '$', ''), ',', '')::NUMERIC,
    boxes_shipped::INT
FROM sales_staging;

select * from sales;

~~  MONTHLY SALES REPORT
1. Total sales per month

SELECT
    DATE_TRUNC('month', sale_date) AS month,
    COUNT(*) AS total_orders,
    SUM("amount($)") AS total_revenue,
    SUM(boxes_shipped) AS total_boxes
FROM sales
GROUP BY DATE_TRUNC('month', sale_date)
order by month;

2. Monthly sales trend

SELECT
    TO_CHAR(sale_date, 'YYYY-MM') AS month,
    SUM("amount($)") AS revenue
FROM sales
GROUP BY TO_CHAR(sale_date, 'YYYY-MM')
ORDER BY month;

~~ SALES BY COUNTRY

1. Country performance summary

SELECT
    country,
    COUNT(*) AS orders,
    SUM("amount($)") AS total_revenue,
    AVG("amount($)") AS avg_order_value,
    SUM(boxes_shipped) AS boxes_shipped
FROM sales
GROUP BY country
ORDER BY total_revenue DESC;

2. Country contribution (% of total sales)

SELECT
    country,
    SUM("amount($)") AS country_sales,
    ROUND(
        SUM("amount($)") * 100.0 / SUM(SUM("amount($)")) OVER (),
        2
    ) AS percentage_of_total
FROM sales
GROUP BY country
ORDER BY country_sales DESC;

~~ SALES BY PRODUCT

1. Product performance

SELECT
    product,
    COUNT(*) AS orders,
    SUM("amount($)") AS revenue,
    SUM(boxes_shipped) AS total_boxes
FROM sales
GROUP BY product
ORDER BY revenue DESC;

2. Top-selling product by revenue

SELECT 
    product,
    SUM("amount($)") AS revenue
FROM sales
GROUP BY product
ORDER BY revenue DESC
LIMIT 1;

~~ RANKINGS
1. Rank products by revenue

SELECT
    product,
    SUM("amount($)") AS revenue,
    RANK() OVER (ORDER BY SUM("amount($)") DESC) AS revenue_rank
FROM sales
GROUP BY product;

2. Top product per country

SELECT *
FROM (
    SELECT
        country,
        product,
        SUM("amount($)") AS revenue,
        RANK() OVER (
            PARTITION BY country
            ORDER BY SUM("amount($)") DESC
        ) AS rnk
    FROM sales
    GROUP BY country, product
) ranked
WHERE rnk = 1;

~~ MONTH-OVER-MONTH GROWTH

SELECT
    month,
    revenue,
    revenue - LAG(revenue) OVER (ORDER BY month) AS growth,
    ROUND(
        (revenue - LAG(revenue) OVER (ORDER BY month)) * 100.0 /
        LAG(revenue) OVER (ORDER BY month),
        2
    ) AS growth_percent
FROM (
    SELECT
        DATE_TRUNC('month', sale_date) AS month,
        SUM("amount($)") AS revenue
    FROM sales
    GROUP BY month
) m;

~~ SALES PERSON PERFORMANCE

SELECT
    sales_person,
    COUNT(*) AS deals_closed,
    SUM("amount($)") AS revenue,
    AVG("amount($)") AS avg_deal_size
FROM sales
GROUP BY sales_person
ORDER BY revenue DESC;


~~ CREATE REPORT VIEWS

1. Monthly summary view

CREATE VIEW monthly_sales_summary AS
SELECT
    DATE_TRUNC('month', sale_date) AS month,
    SUM("amount($)") AS revenue,
    SUM(boxes_shipped) AS boxes_shipped
FROM sales
GROUP BY month
ORDER BY month;

SELECT * FROM monthly_sales_summary;

~~ 8. PERFORMANCE OPTIMIZATION 

CREATE INDEX idx_sales_date ON sales(sale_date);
CREATE INDEX idx_sales_country ON sales(country);
CREATE INDEX idx_sales_product ON sales(product);

